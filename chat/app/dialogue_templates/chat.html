<html>
    <head>
        <title>Who's Our Mutual Friend?</title>

	<style>

	  .clearfix {
	  overflow: auto;
	  }

	  .points {
	  color: #009933;
	  }

	  div#chat_container {
	  float:left;
	  width: 40%;
	  }

	  div#info_container {
	  margin-left: 42%;
	  }

	  textarea#chat {
	  width: 100%;
	  rows: 10;
	  cols: 100;
	  height: 25%;
	  }

	  img.heart {
	  height: 15px;
	  width: 15px;
	  }

	  img.dollar {
	  height: 16px;
	  width: 9px;
	  }

	  input#text {
	  width: 100%;
	  }
	  
	  td {
	  padding: 0 15px 0 15px;
	  }
	  
	  #instructions > p,li {
	  font-size:18px;
	  }
	  
	  table.sortable th:not(.sorttable_sorted):not(.sorttable_sorted_reverse):not(.sorttable_nosort):after { 
    	content: " \25B4\25BE" 
		}

#clockdiv{
    display: inline-block;
    font-weight: bold;
    text-align: center;
    font-size: 18px;
    padding: 15px 0 15px 0;
}

#clockdiv > div{
    display: inline-block;
}

#clockdiv div > span{
    display: inline-block;
}

#clockdiv div > .seconds{
	margin-left:-3px;
}

	</style>

		<script type="text/javascript" src="http://www.kryogenix.org/code/browser/sorttable/sorttable.js"></script> 
        <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
        <script type="text/javascript" charset="utf-8">
            var socket, validCheckInterval;
            var selectTime = null;
            $(document).ready(function(){
                socket = io.connect('http://' + document.domain + ':' + location.port+'/chat');
                socket.on('connect', function() {
                    socket.emit('joined', {});
                });
                socket.on('message', function(data) {
                    $('#chat').val($('#chat').val() + data.msg + '\n');
                    $('#chat').scrollTop($('#chat')[0].scrollHeight);
                });
                 socket.on('disconnect', function() {
 					socket.disconnect();
 					clearInterval(validCheckInterval);
 				});
				socket.on('endchat', function(data) {
					clearInterval(validCheckInterval);
					window.location.reload(true);
				});
               	$('#text').keypress(function(e) {
                    var code = e.keyCode || e.which;
                    if (code == 13) {
                        text = $('#text').val();
                        $('#text').val('');
                        socket.emit('text', {msg: text});
                    }
                });
	    		
	    		$('#ddRestaurants').change(function() {
	    			selected = $('option:selected').val();
	    			if(selectTime == null) {
	    				selectTime = new Date();
	    				socket.emit('pick', {restaurant: selected});
					}
					else {
						var currentTime = new Date();
						if ((currentTime - selectTime) > 10000) {
							socket.emit('pick', {restaurant: selected});
							selectTime = currentTime;
						} //otherwise do nothing
					}
                });
                
				validCheckInterval = setInterval(pollServer, 3000);
            });
            
            function pollServer() {
            	socket.emit('is_chat_valid', {}, function(data) {
                    if (!data['valid']) { 
                        window.location.reload(true);   
                    }
                });
            }

        </script>
        
        <script type="text/javascript" charset="utf-8">
					function getTimeRemaining(endtime) {
					  var t = Date.parse(endtime) - Date.parse(new Date());
					  var seconds = Math.floor((t / 1000) % 60);
					  var minutes = Math.floor((t / 1000 / 60));
					  return {
					    'total': t,
					    'minutes': minutes,
					    'seconds': seconds
					  };
					}

					function initializeClock(id, endtime) {
					  var clock = document.getElementById(id);
					  var minutesSpan = clock.querySelector('.minutes');
					  var secondsSpan = clock.querySelector('.seconds');

					  function updateClock() {
					    var t = getTimeRemaining(endtime);

					    minutesSpan.innerHTML = t.minutes+':';
					    secondsSpan.innerHTML = ('0' + t.seconds).slice(-2);

					    if (t.total <= 0) {
					    	clearInterval(validCheckInterval);
					    	clearInterval(timeinterval);
					    	pollServer();
					    }
					  }

					  updateClock();
					  var timeinterval = setInterval(updateClock, 1000);
					}


					function init() {
					  var deadline = new Date(Date.parse(new Date()) + {{ num_seconds }} * 1000);
					  initializeClock('clockdiv', deadline);
				        }
        </script>
    </head>
    <body onload='init()' oncopy="return false" oncut="return false" onpaste="return false">
      <div class="clearfix">
    <div id="chat_container">
    <div id="instructions">
        <h1>Who's Our Mutual Friend?</h1>
        <p>
            You and another user online have exactly one mutual friend in common. Your goal is to find that mutual friend!
        </p>
	<h2>Instructions</h2>
	<ul>
	  <li> Look at <b>your information</b> (your school and company), and the list of <b>your friends</b> at right. </li>
	  <li> Use the <b>chat box below</b> to find out more about the other user and discover your mutual friend. </li>
	  <li> Once you've found out who it is, select their name from the <b>drop down list on the right</b>.
	  <li style="color:#FF0000"><b>Please select names carefully</b>. If you select a name once, the website will not allow you to select another name for 10 seconds after your first selection.</li>
	</ul>
	</div>

        <div id="clockdiv" align="right">
	  Time Remaining: 
	  <div>
	    <span class="minutes"></span>
	    <span class="seconds"></span>
	  </div>
	</div>

        <textarea readonly id="chat"></textarea><br><br>
        <input id="text" placeholder="Enter your message here"><br><br>

    </div>

    <div id="info_container">
        <div id="preferences">

            <h3>Your information</h3>
            <table class="cuisine_preferences_list">
					<tr>
						<td>Name</td>
						<td>
						{{ agent["info"]["name"] }}
						</td>
				  </tr>
				  <tr>
						<td>School</td>
						<td>
						{{ agent["info"]["school"]["name"] }}
						</td>
				  </tr>
				  <tr>
						<td>Major</td>
						<td>
						{{ agent["info"]["school"]["major"] }}
						</td>
				  </tr>
				  <tr>
						<td>Company</td>
						<td>
						{{ agent["info"]["company"]["name"] }}
						</td>
				  </tr>
			</table>


            <h3>Your friends</h3>
	    <table class="sortable">
	    <thead>
	    <tr>
	    <th>Name</th>
	    <th>School</th>
	    <th>Major</th>
	    <th>Company</th>
	    </tr>
	    </thead>
	    <tbody>
            {% for friend in agent["friends"] %}
            <tr>
				<td><b>{{ friend["name"] }}</b></td>
				<td>{{ friend["school"]["name"]}}</td> 
				<td>{{ friend["school"]["major"]}}</td> 
				<td>{{ friend["company"]["name"]}}</td> 
	    	</tr>
	    {% endfor %}
	    </tbody>
	    </table>
        </div>

        	<h3>Choose a friend below:</h3>
            <select id="ddRestaurants">
            	<option value="-1">Select a friend</option>
                {% set ctr = 0 %}
                {% for friend in agent["friends"] %}
                <option value={{ctr}}>{{ friend["name"] }}</option>
                {% set ctr = ctr + 1 %}
                {% endfor %}
            </select>

    </div>
    </div>
    </body>
</html>
